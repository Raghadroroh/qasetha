# إصلاح مشكلة فهرس Firestore

## المشكلة
كانت شاشة لوحة التحكم تظهر خطأ:
```
cloud_firestore/failed-precondition: The query requires an index
```

## سبب المشكلة
1. عدم تطابق بين حقول الاستعلام في الكود (`sortOrder` و `name`) والفهارس المعرفة في `firestore.indexes.json` (التي كانت تستخدم `order` بدلاً من `sortOrder`)
2. عدم وجود فهرس مركب يتضمن كلا الحقلين `sortOrder` و `name`

## الحلول المنفذة

### 1. تحديث ملف فهارس Firestore
- تم تغيير اسم الحقل من `order` إلى `sortOrder` في ملف `firestore.indexes.json`
- تمت إضافة فهرس مركب جديد يتضمن كلا الحقلين `sortOrder` و `name`

### 2. تبسيط الاستعلام
- تم تعديل `watchMainCategories()` لاستخدام `sortOrder` فقط في استعلام Firestore
- تمت إضافة فرز في الذاكرة حسب الاسم كفرز ثانوي لتجنب الحاجة إلى فهرس مركب معقد

### 3. إضافة آلية احتياطية
- تم إنشاء آلية احتياطية لاستخدام `mainCategoriesProvider` عندما يفشل `mainCategoriesStreamProvider`
- هذا يضمن استمرار عمل التطبيق حتى إذا لم يتم إنشاء الفهرس بعد

### 4. إضافة معالجة أخطاء سهلة الاستخدام
- تم إنشاء فئة `FirestoreIndexHelper` للكشف عن أخطاء الفهرس
- تمت إضافة مربع حوار يظهر عند حدوث خطأ في الفهرس
- تم تضمين رابط قابل للنقر لإنشاء الفهرس المطلوب مباشرة من التطبيق

### 5. إضافة التبعية المطلوبة
- تمت إضافة `url_launcher` إلى `pubspec.yaml` لتمكين فتح عنوان URL لإنشاء الفهرس

## الخطوات التالية
1. تشغيل `flutter pub get` لتثبيت التبعية الجديدة
2. نشر فهارس Firestore المحدثة باستخدام `firebase deploy --only firestore:indexes`
3. اختبار التطبيق للتأكد من تحميل لوحة التحكم بشكل صحيح

## الملفات المعدلة
1. `firestore.indexes.json` - تحديث تعريفات الفهارس
2. `lib/providers/category_provider.dart` - تبسيط استعلام الفئات
3. `lib/screens/dashboard/dashboard_screen.dart` - إضافة معالجة الأخطاء والآلية الاحتياطية
4. `lib/utils/firestore_index_helper.dart` - إنشاء مساعد جديد للتعامل مع أخطاء الفهرس
5. `pubspec.yaml` - إضافة تبعية url_launcher

## فوائد الحل
1. يعمل التطبيق بشكل صحيح مع الفهارس الموجودة
2. يمكن للمستخدمين إنشاء أي فهارس مفقودة بسهولة إذا لزم الأمر
3. يتعامل التطبيق بسلاسة مع أخطاء الفهرس باستخدام آلية احتياطية
4. لن يتسبب الخطأ أبدًا في تعطل التطبيق أو عرض شاشة فارغة